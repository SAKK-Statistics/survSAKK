---
title: "Creating survival plot"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating survival plot}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  eval = TRUE,
  fig.height = 5,
  fig.width = 7,
  fig.align='center'
)
```

After inserting the `survfit{survival}` object into `surv.plot{survSAKK}`, we can create simple survival curves, allowing to visualize survival patterns and incorporate various statistics in our plot.

To show some benefit of this function,  *NCCTG Lung Cancer Data*, available in the survival package is used.

# Setup and Loading Data

```{r setup, warning=FALSE}
# Load required libraries
library(survSAKK)
library(survival)

# Load lung data
lung <- survival::lung

# Compute survival time in months and years
lung$time.m <- lung$time/365.25*12
lung$time.y <- lung$time/365.25

# Create survival objects
fit.lung.d <- survfit(Surv(time, status) ~ 1, data = lung)
fit.lung.m <- survfit(Surv(time.m, status) ~ 1, data = lung)
fit.lung.arm.m <- survfit(Surv(time.m, status) ~ sex, data = lung)
fit.lung.arm.y <- survfit(Surv(time.y, status) ~ sex, data = lung)
```

# Drawing basic survival plot

```{r baseplot1}
# Single arm
surv.plot(fit.lung.m)
# Two arms
surv.plot(fit.lung.arm.m)
```

# Customisation of the survival plot

## Colour, title and axis label

```{r baseplot2}
surv.plot(fit.lung.arm.m,
          # Colour
          col = c("cadetblue2", "cadetblue"),
          # Title
          main = "Kaplan-Meier plot",
          # Axis label
          xlab = "Time since treatment start (months)",
          ylab = "Overall survival (probability)"
)
```


## Legend position, name and title

```{r baseplot3}
# Chose legend position and names of the arms
surv.plot(fit.lung.arm.m,
          legend.position = "bottomleft",
          legend.name = c("Male", "Female")
)
# Chose legend position manually and add a legend title
surv.plot(fit.lung.arm.m,
          legend.position = c(18, 0.9),
          legend.name = c("Male", "Female"),
          legend.title = "Sex"
)
```

## Axis limts, xticks and yticks

```{r baseplot4}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          xticks = seq(0, 36, by = 12), 
          yticks = seq(0, 1, by = 0.2)
)
# Cut curve at 24 months
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          xticks = seq(0, 24, by = 6)
)
```


## Font size

### Global adjustment

```{r baseplot6}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          # Global adjustment
          cex = 1.3
)
```


### Specific adjustments

```{r baseplot7}
surv.plot(fit.lung.arm.m,
          main = "Kaplan-Meier plot",
          legend.name = c("Male", "Female"),
          legend.title = "Sex",
          # Size of X-axis label
          xlab.cex = 1.2,
          # Size of Y-axis label
          ylab.cex = 1.2,
          # Size of axis elements
          axis.cex = 0.8,
          # Size of the censoirng marks
          censoring.cex = 1,
          # Size of the legend title
          legend.title.cex = 1.2,
          # Size of the risktable
          risktable.cex = 0.7,
          # Size of the risktable name
          risktable.name.cex = 0.9
)
```


## Label position X- and Y-axis

### Shift X- and Y-axis label

```{r baseplot8}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          xlab.pos = 6,
          ylab.pos = 5
)
```


## Marging area customisation

```{r baseplot9}
# Change the margins and shift the Y-axis label
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          # New margin area 
          margin.bottom = 6,
          margin.left = 7,
          margin.top = 1,
          margin.right = 2,
          # Define margin of the Y-axis label
          ylab.pos = 4
)
```


## Time unit and Y-axis unit

The parameter `time.unit` can be set as follows: `"day"`, `"week"`, `"month"`,`"year"`.
 
**Note the following:** 

- The `time.unit` needs to correspond to the time unit which was used to calculate the survival object `fit`.

- If `time.unit = "month"` X ticks are automatically chosen by intervals of 6 months. Whereas for `time.unit = "year"` the X ticks are chosen by intervals of 1. 

```{r baseplot10}
# Time unit of month
surv.plot(fit.lung.arm.m,
          time.unit = "month",
          y.unit = "probability",
          legend.name = c("Male", "Female")
)

# Time unit of year
surv.plot(fit.lung.arm.y,
          time.unit = "year",
          y.unit = "percent",
          legend.name = c("Male", "Female")
)
```

# Drawing risk table

Per default the risk table is provided below the Kaplan-Meier plot. It provides information about the number of patients at risk at different time points.

## Undisplay risk table

```{r risktable1}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          risktable = FALSE
)
```

## Risktable position

```{r risktable.pos1}
# Move risk table names and title to the left
surv.plot(fit.lung.arm.m,
          legend.name = c("male", "female"),
          risktable.name.position = -6,
          risktable.title.position = -7
)
```

## Risktable title, colour and label name

```{r risktable.pos2}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          risktable.name = c("M", "F"),
          # Colors of curves are used for the risktable
          risktable.col = TRUE,
          risktable.title = "Number at risk",
          risktable.title.font = 4,
          risktable.title.col = "#E41A1C"
)
```

# Drawing segment

This section explains how to highlight a **specific quantile** or
**time point** as a segment in the survival curve and how to adjust segment annotation.

## For a specific quantile


```{r median}
# Drawing a segment line for the median, which corresponds to 0.5 quantile
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.quantile = 0.5
)
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.quantile = 0.5,
          # Specifying time unit
          time.unit = "month"
)
```


```{r quantile0_75}
# Drawing segment for the 0.75 quantile
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.quantile = 0.75
)
```

## For a specific time point


```{r timepoint}
#  Drawing a segment line at 12 months
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.timepoint = 12
)
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.timepoint = 12,
          # Specifying time unit
          time.unit = "month"
)
```

# Customisation of the segment

## Change position of segment annotation

The parameter `segment.annotation` can take the following values: `c(x,y)`,`"bottomleft"`, `"left"`, `"right"`, `"top"`, `"none"`

```{r segment1}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.timepoint = 18,
          segment.annotation = "top",
          time.unit = "month"
)
```


## Segment title, font, size, and colour

```{r segment2}
surv.plot(fit.lung.arm.m,
          col = c("cadetblue2", "cadetblue"),
          legend.name = c("Male", "Female"),
          time.unit = "month",
          segment.quantile = 0.5,
          segment.font = 10,
          segment.main.font = 11,
          segment.main = "Median PFS in months (95% CI)",
          segment.cex = 0.8,
          segment.annotation.col = "darkgray"
)
```


## Segment lines for different time points / quantile

Note that `segment.annotation` needs to be set to "none". Otherwise the code does not work. 

```{r segment3}
# Several quantiles
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.quantile = c(0.5, 0.25),
          segment.annotation = "none",
          time.unit = "month"
)
# Several time points
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.timepoint = c(6, 18),
          segment.annotation = "none",
          time.unit = "month"
)
```

## Segment line type, line width and text spacing

```{r segment5}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          time.unit = "month",
          segment.quantile = 0.5,
          segment.lwd = 2,
          segment.lty = "dashed",
          # More space between the segment annotation lines
          segment.annotation.space = 0.1
)
```

## Segment annotation short version 

Note that the option `segment.confint = FALSE` only works for two arms. 

```{r segment7}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          time.unit = "month",
          segment.quantile = 0.5,
          segment.confint = FALSE
)
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          time.unit = "month",
          segment.timepoint = 18,
          segment.confint = FALSE,
          segment.annotation = "bottomleft"
)
```

# Modify confidence interval 

```{r segment6}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.quantile = 0.5,
          conf.int = 0.8
)
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          segment.timepoint = 18,
          y.unit = "percent",
          conf.int = 0.9
)
```





# Include statistics

There are three options for the parameter `stat` to display statistics:

- `logrank`: gives the p value of the log rank test calculated using `survdiff{survival}`.

- `coxph`: gives the hazard ratio (HR) and its 95% CI of the conducted Cox proportional hazards regression using `coxph{survival}`.â 

- `coxph_logrank`: is a combination of `logrank` and `coxph`.

## `logrank test`

```{r stat1}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          stat = "logrank",
)
```

## `coxph`

```{r stat2}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          stat = "coxph"
)
```

## `coxph_logrank`

```{r stat3}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          stat = "coxph_logrank"
)
```


# Customisation of the statistics

## Stat position, colour, text size, and text font

```{r stat4}
surv.plot(fit.lung.arm.m,
          legend.name = c("Male", "Female"),
          stat = "logrank",
          stat.position = "right",
          stat.col = "darkgrey",
          stat.cex = 0.8,
          stat.font = 3
)
```


## Stat with redifined reference arm and confidence level

Note that `reference.arm` needs to be set to an existing value of the arm in the `fit` object. 
In this example the arm corresponds to `sex` which is coded as `{1, 2}` in the `lung` data set. 
```{r stat_ref_arm}
surv.plot(fit.lung.arm.m,
          legend.name = c("Female","Male"),
          stat = "coxph_logrank",
          reference.arm = 2,
          stat.conf.int = 0.80
)
```

## Stat with stratification

In the next example the ECOG performance status is used as stratification factor for the calculation of the statistics. 

```{r stat_stratified}
# Fit survival object with stratification
fit_lung_stratified <- survfit(Surv(time.m, status) ~ sex + strata(ph.ecog), data = lung)

surv.plot(fit.lung.arm.m,
          stat.fit = fit_lung_stratified,
          legend.name = c("male", "female"),
          stat = "coxph_logrank"
)
```

# Multiple survival plots

We present two ways how to combine plots: via `par(mfrow=c())` and via `split.screen()`

## Multiple plots using `par(mfrow=c())` 

```{r plots1, fig.height = 8, fig.width = 8}
# Creating 4 sub-plot
par(mfrow=c(2,2))

# Plot 1
surv.plot(fit.lung.d)
# Plot 2
surv.plot(fit.lung.arm.m, 
          legend.name = c("Male", "Female"),
          time.unit = "month")
# Plot 3
surv.plot(fit.lung.arm.y, 
          legend.name = c("Male", "Female"),
          col = c("cadetblue2", "cadetblue"), 
          time.unit = "year", 
          stat = "coxph")
# Plot 4
surv.plot(fit.lung.arm.m,
          # Cusomization of the survival plot
          main = "Kaplan-Meier plot",
          legend.name = c("Male", "Female"),
          legend.title = "Sex",
          xlab.cex = 1.2,
          ylab.cex = 1.2,
          axis.cex = 0.8,
          censoring.cex = 1,
          legend.title.cex = 1.2,
          # Customization of the risktable
          risktable.name.position = -9,
          risktable.title.position = -9,
          risktable.cex = 0.7)
# reset the plotting area
par(mfrow=c(1,1))
```

```{r plots2, fig.height = 10, fig.width = 8}

par(mfrow=c(2,1))
# Plot 1
surv.plot(fit.lung.arm.m, 
          legend.name = c("Male", "Female"),
          col = c("cadetblue2", "cadetblue"), 
          time.unit = "month", 
          segment.quantile = 0.5)
# Plot 2
surv.plot(fit.lung.arm.m, 
          legend.name = c("Male", "Female"),
          col = c("cadetblue2", "cadetblue"), 
          time.unit = "month", 
          segment.timepoint = 6)
par(mfrow=c(1,1))
```

## Multiple plots using `split.screen()` 

```{r plots3, fig.height = 10, fig.width = 8}
split.screen(c(2,1))
screen(1)
surv.plot(fit.lung.arm.m, 
          legend.name = c("Male", "Female"),
          time.unit = "month", 
          segment.quantile = 0.5, 
          segment.confint = FALSE)
screen(2)
surv.plot(fit.lung.arm.m, 
          legend.name = c("Male", "Female"),
          time.unit = "month", 
          segment.quantile = 0.75, 
          segment.confint = FALSE)
close.screen(all = TRUE)
```

